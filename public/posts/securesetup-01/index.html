<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #703ACB;
        }
    </style>

    
    
    
    
    
    

    
    <title>Cyber Security Workstation Setup (Part 1)</title>
    <meta name="description" content="Security penguin and privacy nut. Ready your tinfoil hats and let&#39;s go on an adventure.">
    <meta name="keywords" content='cybersecurity, linux, securesetup'>

    <meta property="og:url" content="//pardonmynoot.com/posts/securesetup-01/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Cyber Security Workstation Setup (Part 1)">
    <meta property="og:description" content="Security penguin and privacy nut. Ready your tinfoil hats and let&#39;s go on an adventure.">
    <meta property="og:image" content="//pardonmynoot.com/images/hacker-cover.jpg">
    <meta property="og:image:secure_url" content="//pardonmynoot.com/images/hacker-cover.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cyber Security Workstation Setup (Part 1)">
    <meta name="twitter:description" content="Security penguin and privacy nut. Ready your tinfoil hats and let&#39;s go on an adventure.">
    <meta property="twitter:domain" content="//pardonmynoot.com/posts/securesetup-01/">
    <meta property="twitter:url" content="//pardonmynoot.com/posts/securesetup-01/">
    <meta name="twitter:image" content="//pardonmynoot.com/images/hacker-cover.jpg">

    
    <link rel="canonical" href="//pardonmynoot.com/posts/securesetup-01/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js" integrity="sha256-7dmFWBv4YN&#43;0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script>

    
    
            <link rel="stylesheet" type="text/css" href="/css/custom.css">
        <link rel="me" href="https://infosec.exchange/@peritz">
    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="//pardonmynoot.com/">
                <img src="//pardonmynoot.com//images/peritz-face.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="//pardonmynoot.com/">Pardon my Noot</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="//pardonmynoot.com/"> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="//pardonmynoot.com/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="//pardonmynoot.com/index.xml"> RSS </a>
            </div>
            
            <div class="nav-link">
                <a href="//pardonmynoot.com/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="//pardonmynoot.com/about/"> About </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="//pardonmynoot.com/"> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="//pardonmynoot.com/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="//pardonmynoot.com/index.xml"> RSS </a>
                </li>
                
                <li class="nav-item">
                    <a href="//pardonmynoot.com/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="//pardonmynoot.com/about/"> About </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Cyber Security Workstation Setup (Part 1)</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            February 24, 2024
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="//pardonmynoot.com/tags/cybersecurity">cybersecurity</a></li>
        
            <li class="post-tag"><a href="//pardonmynoot.com/tags/linux">linux</a></li>
        
            <li class="post-tag"><a href="//pardonmynoot.com/tags/securesetup">securesetup</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <figure><img src="/images/hacker-cover.jpg"
         alt="Hooded figure working at multiple monitors with code and terminals on each."/><figcaption>
            <p>Photo by Kevin Horvat on Unsplash</p>
        </figcaption>
</figure>

<blockquote>
<p>Disclaimer: This is a technical post, so if you&rsquo;re not particularly interested in the technical side of things then this is your warning ðŸ™‚</p>
</blockquote>
<h1 id="cyber-generalism">Cyber Generalism</h1>
<p>I&rsquo;m sure many can relate to the idea of being a cyber generalist. There&rsquo;s many jobs out there that call for someone to understand at a surface level a great deal about how to do things on computers. I did a Computer Science degree with no particular focus, and started my career in penetration testing (ethical hacking to my friends). I&rsquo;ve since moved into an engineering team lead role in a CTI department, which requires a great deal of different cyber skills. I&rsquo;m still the defacto pentester for our team, as well as dealing with traditional DevOps and cloud technologies. I do scripting for various CTI teams and am also expected to understand how to deploy, maintain, and secure technologies ranging from kubernetes clusters to traditional on-prem LAMP stacks.</p>
<p>I&rsquo;ve had a journey that has seen my preference for OS change drastically from being a hardcore Windows supporter (large customisation of my machine via PowerShell), to an avid fan of Apple (everything just works), and finally settling on Linux in various shades. In work the standard has been to use Windows, and there are a tonne of internal tools for hardening it and customising it to fit our needs. We used VMs for things like Kali and any Linux distros we needed for our day-to-day testing, but many people did lots of their work inside Windows.</p>
<p>This just doesn&rsquo;t work for me any more. There&rsquo;s only so far you get can with Windows Subsystem for Linux and using VMs on a Windows machine for all your work feels backwards (Windows takes more resources than my VMs but I do all my work in VMs? Doesn&rsquo;t make sense). I reached out to a few colleagues elsewhere in the business who do general cyber-stuff and they had come up with an interesting solution. They conduct all their work inside VMs, running on lightweight base OSes, and network them in such a way as to segregate their responsibilities. These are people who conduct CTI operations on the likes of Tor and need to keep OpSec strong. They also do a lot of malware reversing which brings a whole host of risks. Some of this they do on the same machine as their corporate access, so you can imagine the risks they need to consider.</p>
<p>Their solution I want to create looks something like the following:</p>
<figure><img src="/images/securesetup-vyos.png"
         alt="Diagram depicting the networking setup for my workstation using VyOS as a software router routing traffic from multiple interfaces via a firewall and a series of VPNs depending on the intended destination of traffic"/><figcaption>
            <p>Secure setup using VyOS as a software router</p>
        </figcaption>
</figure>

<p>There are multiple VPNs running inside a router VM (VyOS in this case). All machines get routed through a firewall prior to the VPNs, and the corporate ones get routed through a proxy which limits the domains that can be connected to. Our corporate VPN is a Cisco AnyConnect VPN, which isn&rsquo;t available as a client on VyOS, so we create another VM running the client and push all corporate traffic through that. All the other VPNs are OpenVPN and can be added as interfaces in VyOS.</p>
<p>I also do some HackTheBox in my spare time, which is why there is a HTB VPN and dedicated VM. Additionally, we have resources deployed in AWS that we access via a VPN, so this is another network connection.</p>
<p>Each VPN network is assigned it&rsquo;s own virtual network which machines connect to and have their traffic routed accordingly. Altogether we separate our concerns appropriately and are able to conduct a variety of activities on one machine with a minimal amount of risk.</p>
<p>Through this and subsequent posts I will describe in detail how I installed this setup on my work machine (a beefy Dell laptop with 64GB of RAM, a NVIDIA graphics card, and an Intel 12th Gen i7 processor).</p>
<p>This post will cover the initial installation of the operating system on the base machine, as well as connecting it to the network and installing QEMU and libvirt for virtualisation. Subsequent posts will cover the virtual networking setup needed and the installation of VPNs and virtual machines for work.</p>
<h1 id="base-os-selection">Base OS Selection</h1>
<p>I chose Arch Linux as my base operating system and activated KVM as the hypervisor. KVM is ideal for me since all my work will be conducted in VMs, and KVM essentially transforms the Linux kernel into a hypervisor. There are some helpful utilities installed which allow me to browser the web, access a UI, and various other things that will be necessary to install our VMs. Once everything is set up I can remove most of the bloat and keep the base OS as slim as possible.</p>
<p>Why Arch Linux? I&rsquo;m fond of the involvement it requires to get things running. It is a very slim OS to begin with and you can limit your software to only what is needed to get a job done. The less that is installed on my base and the less resources it uses the better, as it allows me to allocate more to my VMs. Additionally, it has a rolling updates system which I prefer over the distribution versions used in Debian-derivatives. I&rsquo;m not familiar enough with other UNIX distributions to have considered them, but Arch Linux has given me exactly what I want in the past.</p>
<p>Note that the selection of Arch is a personal preference, since KVM is included in most mainline distros within the kernel.</p>
<p>Let&rsquo;s get into the install process.</p>
<h1 id="installation">Installation</h1>
<blockquote>
<p>More information about this process can be found at the Arch Linux wiki: <a href="https://wiki.archlinux.org/title/Installation_guide">https://wiki.archlinux.org/title/Installation_guide</a></p>
</blockquote>
<p>Navigate to <a href="https://archlinux.org/download/">https://archlinux.org/download/</a> and download from one of the mirrors. Verify it against the SHA256 signature. If you are concerned about the safety of your network, then also check it against the PGP signature. This is done by downloading the signature file and running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gpg --keyserver-options auto-key-retrieve --verify archlinux-_version_-x86_64.iso.sig
</span></span></code></pre></div><p>Using Balena Etcher flash the ISO image to a USB stick. Disable secure boot and enable USB boot support in your BIOS settings, then reboot in to the live install environment.</p>
<p>We&rsquo;re going to be running with <a href="https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system#LVM_on_LUKS">dm-crypt on top of LVM</a>. This is the easiest method for allowing suspension to disk and is what I&rsquo;ve used before on previous Linux installations.</p>
<p>Once we have booted into the live installation medium, we can perform the following install:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>localectl list-keymaps
</span></span><span style="display:flex;"><span>loadkeys uk
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify 64-bit or 32-bit</span>
</span></span><span style="display:flex;"><span>cat /sys/firmware/efi/fw_platform_size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enter a tmux pane to make scrollback a bit easier with C-b PPage</span>
</span></span><span style="display:flex;"><span>tmux
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Connect to wifi</span>
</span></span><span style="display:flex;"><span>iwctl
</span></span><span style="display:flex;"><span>station list
</span></span><span style="display:flex;"><span>station wlan0 scan
</span></span><span style="display:flex;"><span>station wlan0 get-networks
</span></span><span style="display:flex;"><span>station wlan0 connect &lt;network&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Verify</span>
</span></span><span style="display:flex;"><span>ping archlinux.org
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update clock</span>
</span></span><span style="display:flex;"><span>timedatectl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Now partition disk - for us we use our secondary nvme - nvme1n1</span>
</span></span><span style="display:flex;"><span>gdisk /dev/nvme1n1
</span></span><span style="display:flex;"><span>o <span style="color:#75715e"># create new GUID partition table</span>
</span></span><span style="display:flex;"><span>n <span style="color:#75715e"># New partition of type EF00 and size 512MB</span>
</span></span><span style="display:flex;"><span>n <span style="color:#75715e"># New partition of type 8309 and remainder of size</span>
</span></span><span style="display:flex;"><span>p <span style="color:#75715e"># Print table to verify</span>
</span></span><span style="display:flex;"><span>w <span style="color:#75715e"># Write and exit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Encrypt drives now</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create the container - use pbkdf2 for GRUB2 compatibility:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://wiki.archlinux.org/title/GRUB#LUKS2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://savannah.gnu.org/bugs/?55093</span>
</span></span><span style="display:flex;"><span>cryptsetup luksFormat --pbkdf pbkdf2 /dev/nvme1n1p2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Open the container</span>
</span></span><span style="display:flex;"><span>cryptsetup open /dev/nvme1n1p2 cryptlvm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create a physical volume on top of the opened drive</span>
</span></span><span style="display:flex;"><span>pvcreate /dev/mapper/cryptlvm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create the volume group and volumes</span>
</span></span><span style="display:flex;"><span>vgcreate VolGroup /dev/mapper/cryptlvm
</span></span><span style="display:flex;"><span>lvcreate -L 72G VolGroup -n swap <span style="color:#75715e"># RAM + sqroot(RAM) for hibernation</span>
</span></span><span style="display:flex;"><span>lvCreate -l 100%FREE VolGroup -n root <span style="color:#75715e"># Likely don&#39;t need separate paritions outside of HOME</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Format the filesystems</span>
</span></span><span style="display:flex;"><span>mkfs.ext4 /dev/VolGroup/root
</span></span><span style="display:flex;"><span>mkfs.fat -F <span style="color:#ae81ff">32</span> /dev/nvme1n1p1
</span></span><span style="display:flex;"><span>mkswap /dev/VolGroup/swap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Worth a note here that you should make a note of the UUIDs of your disks&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Otherwise, use `ls -l /dev/disk/by-uuid/` later on&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mount</span>
</span></span><span style="display:flex;"><span>mount /dev/VolGroup/root /mnt
</span></span><span style="display:flex;"><span>swapon /dev/VolGroup/swap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># EFI partition</span>
</span></span><span style="display:flex;"><span>mkdir /mnt/efi
</span></span><span style="display:flex;"><span>mount /dev/nvme1n1p1 /mnt/efi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Chroot in</span>
</span></span><span style="display:flex;"><span>pacstrap /mnt base linux-hardened linux-firmware util-linux vim grep grub efibootmgr man-db man-pages texinfo e2fsprogs exfatprogs networkmanager lvm2 inetutils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>arch-chroot /mnt
</span></span></code></pre></div><p>Note that I have opted for the <code>linux-hardened</code> kernel which adds numerous security enhancements on top of the normal kernel. This is a personal selection made as the result of the environment in which I work.</p>
<h1 id="system-boot-configuration">System boot configuration</h1>
<p>We need to take several steps before we can actually boot into this system</p>
<p>First, create an extra keyfile so that GRUB doesn&rsquo;t ask for a password twice</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>dd bs<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span> count<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/random of<span style="color:#f92672">=</span>/root/cryptlvm.keyfile iflag<span style="color:#f92672">=</span>fullblock
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">000</span> /root/cryptlvm.keyfile
</span></span><span style="display:flex;"><span>cryptsetup -v luksAddKey /dev/nvme1n1p2 /root/cryptlvm.keyfile
</span></span></code></pre></div><p>Next, we need to install the intel microcode to mitigate hardware exploits, and then configure the initramfs (initial RAM filesystem):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pacman -S intel-ucode
</span></span></code></pre></div><p>edit the following in /etc/mkinitcpio.conf:</p>
<pre tabindex="0"><code>FILES=(/root/cryptlvm.keyfile)

HOOKS=(base udev autodetect keyboard keymap consolefont modconf block encrypt lvm2 filesystems fsck)
</code></pre><p>Then install the initramfs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mkinitcpio -P
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Protect keyfile</span>
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">600</span> /boot/initramfs-linux*
</span></span></code></pre></div><p>For now, let&rsquo;s continue with some essential configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ln -sf /usr/share/zoneinfo/GB /etc/localtime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hwclock --systohc
</span></span></code></pre></div><p>Uncomment <code>en_GB.UTF-8 UTF-8</code> from <code>/etc/locale.gen</code> then run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>locale-gen
</span></span></code></pre></div><p>Edit <code>/etc/locale.conf</code> with <code>LANG=en_GB.UTF-8</code> and <code>/etc/vconsole.conf</code> with <code>KEYMAP=uk</code></p>
<p>Create a hostname in <code>/etc/hostname</code>.</p>
<p>Set a root password with <code>passwd</code> and then install the bootloader:</p>
<p>Check that your SSD supports TRIM using <code>lsblk --discards</code>. If not then omit the <code>allow-discards</code> option from the following GRUB config. Edit <code>/etc/default/grub</code>:</p>
<pre tabindex="0"><code>GRUB_ENABLE_CRYPTODISK=y

GRUB_CMDLINE_LINUX=&#34;. . . cryptdevice=UUID=deviceuuid:cryptlvm:allow-discards cryptkey=rootfs:/root/cryptlvm.keyfile resume=/dev/VolGroup/swap&#34;

GRUB_PRELOAD_MODULES=&#34;part_gpt part_msdos lvm&#34;
</code></pre><p>If you wrote the above literally then you will need to get the UUID of the disk:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>uuid<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ls -al /dev/disk/by-uuid | grep nvme1n1p2 | awk <span style="color:#e6db74">&#39;{ print $9 }&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/deviceuuid/</span>$uuid<span style="color:#e6db74">/&#34;</span> /etc/default/grub
</span></span></code></pre></div><p>Cat the <code>/etc/default/grub</code> file to double check this worked.</p>
<p>Now install GRUB:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>grub-install --target<span style="color:#f92672">=</span>x86_64-efi --efi-directory<span style="color:#f92672">=</span>/efi --bootloader-id<span style="color:#f92672">=</span>GRUB --recheck
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>At this point we can reboot and login:</p>
<pre tabindex="0"><code>Ctrl-D

umount -R /mnt

reboot
</code></pre><h1 id="networking">Networking</h1>
<p>Now that we have booted into our system, we can connect back to wifi (won&rsquo;t be necessary if you&rsquo;re already using ethernet):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl enable --now NetworkManager
</span></span><span style="display:flex;"><span>systemctl enable --now wpa_supplicant
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nmcli device wifi list
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Don&#39;t forget the space below to avoid password ending up in console history</span>
</span></span><span style="display:flex;"><span> nmcli device wifi connect BSSID_OR_SSID password &lt;password&gt;
</span></span></code></pre></div><h1 id="secure-boot-configuration">Secure boot configuration</h1>
<p>Secure Boot implementations use these keys:</p>
<p>Platform Key (PK)
Top-level key.
Key Exchange Key (KEK)
Keys used to sign Signatures Database and Forbidden Signatures Database updates.
Signature Database (db)
Contains keys and/or hashes of allowed EFI binaries.
Forbidden Signatures Database (dbx)
Contains keys and/or hashes of deny-listed EFI binaries.</p>
<p>We need at least PK, KEK, and db in order for this to work. First, backup the keys that we have already in the database, maybe to a USB stick UNENCRYPTED so that it can be recovered from the firmware settings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pacman -S efitools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> var in PK KEK db dbxÂ ; <span style="color:#66d9ef">do</span> efi-readvar -v $var -o old_<span style="color:#e6db74">${</span>var<span style="color:#e6db74">}</span>.eslÂ ; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>Before we can go further, we need SecureBoot to be in setup mode. This means the PK must be removed. If required (check output of last command if required) then remove it in the BIOS settings. On my laptop BIOS it was also required to enable the &ldquo;Custom Mode&rdquo; from the firmware Boot Configuration settings and run the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chattr -i /sys/firmware/efi/efivars/KEK-UUID
</span></span><span style="display:flex;"><span>chattr -i /sys/firmware/efi/efivars/db-UUID
</span></span></code></pre></div><p><code>sbctl</code> is a Secure Boot helper utility:</p>
<pre tabindex="0"><code>pacman -S sbctl
</code></pre><p>Check that we are in Setup Mode:</p>
<pre tabindex="0"><code>sbctl status
</code></pre><p>Then create our keys and enroll them (alongside Microsoft&rsquo;s)</p>
<pre tabindex="0"><code>sbctl create-keys

sbctl enroll-keys -m
</code></pre><p>Check with <code>sbctl status</code> that it now shows as being installed and Setup Mode as being disabled. Then sign your stuff and re-install grub onto the EFI:</p>
<pre tabindex="0"><code>grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB --modules=&#34;tpm&#34; --disable-shim-lock

sbctl sign -s /boot/vmlinuz-linux-hardened
sbctl sign -s /efi/EFI/GRUB/grubx64.efi
</code></pre><p>Reboot, then boot into firmware settings and enable Secure Boot again.</p>
<h1 id="general-system-configuration">General System Configuration</h1>
<p>Now that we have a secure boot enabled Linux installation, fully encrypted with swap and all sorts of nice security features, we need to configure the system for our needs. This is probably by far going to be the longest section, as lots of things are needed for this to work.</p>
<h2 id="security-configuration">Security Configuration</h2>
<p>The Arch Linux wiki offers a number of suggestions for hardening a system. First among these is a regular user, rather than root, but who has sudo privileges. This is fine since a password entry is needed to run these commands as root:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>useradd --create-home --user-group consultant
</span></span><span style="display:flex;"><span>pacman -S sudo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Uncomment the line beginnning with %wheel which allows anyone belonging</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to the sudo group to run commands as root entering a password. Ensure to</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># uncomment the first one, not the second, which allows the same without</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># entering a password.</span>
</span></span><span style="display:flex;"><span>EDITOR<span style="color:#f92672">=</span>vim sudoedit /etc/sudoers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>usermod -aG wheel consultant
</span></span><span style="display:flex;"><span>passwd consultant
</span></span></code></pre></div><p>There is a discussion here around whether or not this should be done. Really we could disallow the consultant user from accessing sudo altogether, instead opting for <code>su root</code> and entering the root password. I feel like this is sufficient though.</p>
<p>Beyond this, read through <a href="https://wiki.archlinux.org/title/Security">https://wiki.archlinux.org/title/Security</a> and get an idea of what is needed. You&rsquo;ll run commands to check that everything is in place, and to check the general security for your system. This is what was run in my case:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Check if we are vulnerable to known exploits</span>
</span></span><span style="display:flex;"><span>grep -r . /sys/devices/system/cpu/vulnerabilities
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ensure that microcode was loaded</span>
</span></span><span style="display:flex;"><span>journalctl -k --grep<span style="color:#f92672">=</span>microcode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add the following line to /etc/pam.d/system-login</span>
</span></span><span style="display:flex;"><span>auth optional pam_faildelay.so delay<span style="color:#f92672">=</span><span style="color:#ae81ff">4000000</span>
</span></span></code></pre></div><p>I have opted not to do the following for my base machine, for performance/usability reasons (but may use with guest VMs):</p>
<ul>
<li>hardened_malloc</li>
<li>filesystem quotas - we&rsquo;re not running a server with logs</li>
<li>configure <code>pam_faillock.so</code> at <code>/etc/security/faillock.conf</code> with stricter options</li>
<li>Edit <code>/etc/security/limits.conf</code> with stricter process limits</li>
<li>Locking root - we maintain for emergencies (could also be achieved with live boot of a linux install medium)</li>
<li>Edit <code>/etc/security/access.conf</code> to control how users are allowed to login, as it is only a local machine for a single user</li>
<li>AppArmour - at least not for the base machine</li>
<li>Firewalls on the base machine</li>
</ul>
<p>Note that because we are using the <code>linux-hardened</code> kernel, some drivers that sit outside the main tree need to be substituted by their DKMS equivalents. See the <a href="https://wiki.archlinux.org/title/Dynamic_Kernel_Module_Support">relevant page</a> on the arch wiki for this.</p>
<p>The <code>linux-hardened</code> kernel sets a bunch of security features on by default, such as hardening for BPF and disabling kexec to allow changes to the kernel during runtime.</p>
<h2 id="window-manager-and-displaying-stuff">Window Manager and Displaying Stuff</h2>
<p>We need to now work on actual graphics so we can start creating virtual machines and using them. I&rsquo;ve had a number of thoughts on doing this, and considered moving to Wayland for security reasons, but I think this may be more troublesome than it&rsquo;s worth, at least for this part of my career. Instead, I&rsquo;m opting to use Xorg.</p>
<p>I currently use i3 as my window manager; I&rsquo;m a big fan of the tiled layout and workspaces. It works well for me since I conduct most of my editing in Neovim and use Tmux to persist sessions and allow me to do multiple activities from one console (which I can later detach and reattach).</p>
<p>I wanted to have each VM occupy my entire screen almost as if it was running on the base system (making the use of a VM totally transparent). After some research, it&rsquo;s becoming apparent that it is not possible to place a VM window created by qemu in it&rsquo;s own dedicated virtual terminal unless I wanted to login multiple times across multiple terminals to do it. This can be done, but I still need to be able to display things. See this answer from <a href="https://unix.stackexchange.com/q/550892">StackExchange</a>:</p>
<blockquote>
<p>You can start another X11 server and run qemu in full screen mode inside it. As root: <code>startx -- :1; xauth extract - :1 | su USER -c 'xauth merge -'</code>. Then as USER: <code>DISPLAY=:1 qemu -full-screen ...</code>. You can then switch between qemu and your gui screen via ctrl-alt-Fx. This may have problems with the screen resolution adjusment in the guest, but it&rsquo;s a start. qemu/SDL or whatever backend could probably run without an X11 server, but I have no idea how/if accelerated qemu video card emulations like virtio work with it.</p>
<p>â€“Â user313992</p>
</blockquote>
<p>To get all the graphics and nice stuff working for our laptop, we need to install relevant drivers for the NVIDIA graphics card we have on board, as well as configuring X11 and a window server to run things on. We&rsquo;ll also install git and a better shell so that we can do some customisation using (my custom) dotfiles:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pacman -S linux-hardened-headers dkms nvidia-dkms xorg xorg-xinit i3 dmenu git openssh zsh neovim pkgconf rxvt-unicode ttf-anonymous-pro
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>reboot
</span></span></code></pre></div><p>Now that we&rsquo;ve got things installed, let&rsquo;s do some fun configuration (as unprived user) and add key to GitHub before you clone:</p>
<pre tabindex="0"><code>ssh-keygen -t ed25519 -C &#34;Arch Hypervisor&#34;

mkdir git &amp;&amp; cd git
git clone --recurse-submodules git@github.com:peritz/dotfiles.git

cd dotfiles
./install.sh

# For neovim Packer
pacman -S zip unzip python python-virtualenv npm go
</code></pre><p>Now let&rsquo;s install our neovim packages. In neovim:</p>
<pre tabindex="0"><code>:PackerSync
:Mason
</code></pre><p>When you logout and login again now you&rsquo;ll hopefully find that your configuration causes a window manager to pop up. If not and X starts and then logs you out and there&rsquo;s no error in <code>/var/log/Xorg.0.log</code> then it might be your xinitrc has failed to launch anything. Check it to find out.</p>
<p>The brightness keys and audio won&rsquo;t work by default, this is the next thing we need to sort out.</p>
<h2 id="audio-and-brightness">Audio and Brightness</h2>
<p><a href="https://wiki.archlinux.org/title/Backlight">https://wiki.archlinux.org/title/Backlight</a> provides most of the information required for a backlight. The exact steps I took are as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Use brightnessctl since xbacklight wasn&#39;t working</span>
</span></span><span style="display:flex;"><span>sudo pacman -S brightnessctl
</span></span></code></pre></div><p>I put the following in my i3 configuration:</p>
<pre tabindex="0"><code>set $refresh_i3status killall -SIGUSER1 i3status
bindsym XF86MonBrightnessUp exec --no-startup-id brightnessctl set +5% &amp;&amp; $refresh_i3status
bindsym XF86MonBrightnessDown exec --no-startup-id brightnessctl set 5%- &amp;&amp; $refresh_i3status
</code></pre><p>For sound, we need to install alsa-utils and PulseAudio (makes managing sound a bit easier):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo pacman -S alsa-utils pulseaudio pulseaudio-alsa
</span></span></code></pre></div><p>Now if we run <code>alsamixer</code> and press <code>m</code> on the channels that show <code>MM</code> we should be good to go.</p>
<p>We can install PulseAudio, but I&rsquo;ll avoid that until necessary.</p>
<p>I add the following to my i3 config:</p>
<pre tabindex="0"><code>bindsym XF86AudioRaiseVolume exec --no-startup-id amixer set Master 5%+ &amp;&amp; $refresh_i3status
bindsym XF86AudioLowerVolume exec --no-startup-id amixer set Master 5%- &amp;&amp; $refresh_i3status
bindsym XF86AudioMute exec --no-startup-id amixer set Master toggle &amp;&amp; $refresh_i3status
</code></pre><p>Make sure that in your i3status config that the volume device is set to <code>default</code> if you are using ALSA without PulseAudio. I later installed PulseAudio since hotplugging of devices wasn&rsquo;t working with pure ALSA.</p>
<p>Now things should work :) Onwards and upwards because we have a WM and a shell and we can start installing and running things.</p>
<p>Next steps will be to configure virtual networking and the VMs. Until next time!</p>
<hr>
<p><em>If you have any questions, please get in touch at
<a href="mailto:peritz@pardonmynoot.com">peritz@pardonmynoot.com</a>.</em></p>

        </p>
        
    </div>

    <div class="prev-next">
        
            
                
<div class="prev-post">
    <p>
        <a href="/posts/persec-01/">
            &#8592;
            Previous:
            Intro to Personal Security
        </a>
    </p>
    <p class="prev-post-date">
        August 4, 2023
    </p>
</div>




            
        
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#cyber-generalism">Cyber Generalism</a></li>
    <li><a href="#base-os-selection">Base OS Selection</a></li>
    <li><a href="#installation">Installation</a></li>
    <li><a href="#system-boot-configuration">System boot configuration</a></li>
    <li><a href="#networking">Networking</a></li>
    <li><a href="#secure-boot-configuration">Secure boot configuration</a></li>
    <li><a href="#general-system-configuration">General System Configuration</a>
      <ul>
        <li><a href="#security-configuration">Security Configuration</a></li>
        <li><a href="#window-manager-and-displaying-stuff">Window Manager and Displaying Stuff</a></li>
        <li><a href="#audio-and-brightness">Audio and Brightness</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    
    

    
    <span>&copy; 2024 Peritz (https://github.com/peritz), all rights reserved</span>
    
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
